{# templates/includes/navbar.html — Main navigation bar #}
{% load static %}

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">

    <!-- ✅ Brand Logo -->
    <a class="navbar-brand" href="{% url 'jobs:job_list' %}">JobPortal</a>

    <!-- ✅ Navbar links -->
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">

        {% if user.is_authenticated %}
          <!-- ✅ Profile dropdown for logged-in user -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">
              <img src="{{ user.profile_image.url }}" alt="Profile"
                   class="rounded-circle" style="width:35px; height:35px;">
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              
              {% if user.role == 'employee' %}
                <li><a class="dropdown-item" href="{% url 'accounts:employee_dashboard' %}">Profile</a></li>
                <li><a class="dropdown-item" href="{% url 'jobs:my_applications' %}">My Applications</a></li>
              {% elif user.role == 'employer' %}
                <li><a class="dropdown-item" href="{% url 'accounts:employer_dashboard' %}">Profile</a></li>
              {% endif %}

              <li><hr class="dropdown-divider"></li>
              <li><a href="#" class="dropdown-item" onclick="logoutUser(event)">Logout</a></li>
            </ul>
          </li>

        {% else %}
          <!-- ✅ Links for visitors -->
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:login' %}">Sign In</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:login' %}">Employer</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- ✅ Logout Script (AJAX + fallback) -->
<script>
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

function logoutUser(event) {
  event.preventDefault();

  fetch("{% url 'accounts:logout' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie('csrftoken'),
      "X-Requested-With": "XMLHttpRequest",
      "Content-Type": "application/json"
    },
    credentials: "same-origin"
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // ✅ Reload to update navbar after logout
      window.location.reload(true);
    } else {
      alert("Logout failed.");
    }
  })
  .catch(err => {
    console.error("Logout error:", err);
    // ✅ Fallback: normal redirect if JS fails
    window.location.href = "{% url 'accounts:logout' %}";
  });
}
</script>

